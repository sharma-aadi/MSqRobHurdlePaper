---
title: "beta-binomial test for the CPTAC dataset"
author: "Ludger Goeminne"
date: "08-11-2019"
output: html_document
---

# Beta-binomial test for the CPTAC dataset

The implementation of the beta-binomial test through the `ibb` package can be found here:
http://oncoproteomics.nl/statistical-analysis-of-count-data/

Set working directory and load all necessary libraries and functions.

```{r}
# If not installed, install and load the package "here", else: only load the package.
err <- try(library("here", character.only = TRUE), silent = TRUE)
if (class(err) == 'try-error') {
  install.packages("here", repos = "https://cloud.r-project.org")
  library("here", character.only = TRUE)
}

wd <- here()

# Optional: change the working directory
setwd(wd)

# Load all functions and libraries
source(paste0(wd, "/R/functions.r"))
```

Important: make sure you have run 1_analysis_CPTAC_MSqRob.Rmd and prepare_spectral_counts.Rmd OR load `peptides.CPTAC2`, `prot.CPTAC.co`, `prot.CPTAC.spectral.co` and `res.CPTAC.Base` via:

```{r}
load(paste0(wd, "/save_files_CPTAC/peptides_CPTAC2.RData"))
load(paste0(wd, "/save_files_CPTAC/prot_CPTAC_co.RData"))
load(paste0(wd, "/save_files_CPTAC/prot_CPTAC_spectral_co.RData"))
load(paste0(wd, "/save_files_CPTAC/res_CPTAC_Base.RData"))
```

Give session info for reproducibility.

```{r}
sessionInfo()
```

## 1. Beta-binomial test for peptide counts

```{r}
# Beta-binomial test analysis
# Note that the p-values that are generated by the bb.test function are not corrected for multiple testing, we thus need to generate the q-values ourselves.

selection <- which(pData(prot.CPTAC.co)$condition %in% c("6A", "6B"))
x <- exprs(prot.CPTAC.co)[,selection]
tx <- colSums(exprs(prot.CPTAC.co)[,selection])
group <- as.character(pData(prot.CPTAC.co)$condition)[selection]
res.beta.binom.BvsA <- bb.test(x, tx, group) %>% as.data.frame
res.beta.binom.BvsA$protein <- rownames(x)
res.beta.binom.BvsA$contrast <- "condition6B-condition6A"
res.beta.binom.BvsA$qvalue <- p.adjust(res.beta.binom.BvsA$p.value, method = "BH")

selection <- which(pData(prot.CPTAC.co)$condition %in% c("6A", "6C"))
x <- exprs(prot.CPTAC.co)[,selection]
tx <- colSums(exprs(prot.CPTAC.co)[,selection])
group <- as.character(pData(prot.CPTAC.co)$condition)[selection]
res.beta.binom.CvsA <- bb.test(x, tx, group) %>% as.data.frame
res.beta.binom.CvsA$protein <- rownames(x)
res.beta.binom.CvsA$contrast <- "condition6C-condition6A"
res.beta.binom.CvsA$qvalue <- p.adjust(res.beta.binom.CvsA$p.value, method = "BH")

selection <- which(pData(prot.CPTAC.co)$condition %in% c("6B", "6C"))
x <- exprs(prot.CPTAC.co)[,selection]
tx <- colSums(exprs(prot.CPTAC.co)[,selection])
group <- as.character(pData(prot.CPTAC.co)$condition)[selection]
res.beta.binom.CvsB <- bb.test(x, tx, group) %>% as.data.frame
res.beta.binom.CvsB$protein <- rownames(x)
res.beta.binom.CvsB$contrast <- "condition6C-condition6B"
res.beta.binom.CvsB$qvalue <- p.adjust(res.beta.binom.CvsB$p.value, method = "BH")

res.beta.binom <- rbind(res.beta.binom.BvsA, res.beta.binom.CvsA, res.beta.binom.CvsB)
res.CPTAC.beta.binom.full <- res.CPTAC.Base %>% left_join(res.beta.binom)
res.CPTAC.beta.binom.full <- res.CPTAC.beta.binom.full %>% arrange(p.value)

# Or load the result object via:
# load(paste0(wd, "/save_files_CPTAC/res_CPTAC_beta_binom_full.RData"))
```

## 2. Beta-binomial test for spectral counts

```{r}
# Beta-binomial test analysis
# Note that the p-values that are generated by the bb.test function are not corrected for multiple testing, we thus need to generate the q-values ourselves.

selection <- which(pData(prot.CPTAC.spectral.co)$condition %in% c("6A", "6B"))
x <- exprs(prot.CPTAC.spectral.co)[,selection]
tx <- colSums(exprs(prot.CPTAC.spectral.co)[,selection])
group <- as.character(pData(prot.CPTAC.spectral.co)$condition)[selection]
res.beta.binom.BvsA <- bb.test(x, tx, group) %>% as.data.frame
res.beta.binom.BvsA$protein <- rownames(x)
res.beta.binom.BvsA$contrast <- "condition6B-condition6A"
res.beta.binom.BvsA$qvalue <- p.adjust(res.beta.binom.BvsA$p.value, method = "BH")

selection <- which(pData(prot.CPTAC.spectral.co)$condition %in% c("6A", "6C"))
x <- exprs(prot.CPTAC.spectral.co)[,selection]
tx <- colSums(exprs(prot.CPTAC.spectral.co)[,selection])
group <- as.character(pData(prot.CPTAC.spectral.co)$condition)[selection]
res.beta.binom.CvsA <- bb.test(x, tx, group) %>% as.data.frame
res.beta.binom.CvsA$protein <- rownames(x)
res.beta.binom.CvsA$contrast <- "condition6C-condition6A"
res.beta.binom.CvsA$qvalue <- p.adjust(res.beta.binom.CvsA$p.value, method = "BH")

selection <- which(pData(prot.CPTAC.spectral.co)$condition %in% c("6B", "6C"))
x <- exprs(prot.CPTAC.spectral.co)[,selection]
tx <- colSums(exprs(prot.CPTAC.spectral.co)[,selection])
group <- as.character(pData(prot.CPTAC.spectral.co)$condition)[selection]
res.beta.binom.CvsB <- bb.test(x, tx, group) %>% as.data.frame
res.beta.binom.CvsB$protein <- rownames(x)
res.beta.binom.CvsB$contrast <- "condition6C-condition6B"
res.beta.binom.CvsB$qvalue <- p.adjust(res.beta.binom.CvsB$p.value, method = "BH")

res.beta.binom <- rbind(res.beta.binom.BvsA, res.beta.binom.CvsA, res.beta.binom.CvsB)
res.CPTAC.beta.binom.sc.full <- res.CPTAC.Base %>% left_join(res.beta.binom)
res.CPTAC.beta.binom.sc.full <- res.CPTAC.beta.binom.sc.full %>% arrange(p.value)

# Or load the result object via:
# load(paste0(wd, "/save_files_CPTAC/res_CPTAC_beta_binom_sc_full.RData"))
```

