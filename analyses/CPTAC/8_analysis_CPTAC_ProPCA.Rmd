---
title: "ProPCA analysis for the CPTAC dataset"
author: "Ludger Goeminne"
date: "24/3/2018"
output: html_document
---

# ProPCA for the CPTAC dataset

Set working directory and load all necessary libraries and functions.

```{r}
# If not installed, install and load the package "here", else: only load the package.
err <- try(library("here", character.only = TRUE), silent = TRUE)
if (class(err) == 'try-error') {
  install.packages("here", repos = "https://cloud.r-project.org")
  library("here", character.only = TRUE)
}

wd <- here()

# Optional: change the working directory
setwd(wd)

# Load all functions and libraries
source(paste0(wd, "/R/functions.r"))
source(paste0(wd, "/R/proPCA.r"))
```

Important: make sure you have run 1_analysis_CPTAC_MSqRob.Rmd OR load `peptides.CPTAC`, `peptides.CPTAC2` and `res.CPTAC.Base` via:

```{r}
load(paste0(wd, "/save_files_CPTAC/peptides_CPTAC.RData"))
load(paste0(wd, "/save_files_CPTAC/peptides_CPTAC2.RData"))
load(paste0(wd, "/save_files_CPTAC/res_CPTAC_Base.RData"))
```

Give session info for reproducibility.

```{r}
sessionInfo()
```

## 1. Data import

First, we specify the location of the evidence.txt MaxQuant output file.

```{r}
# The evidence.txt file was with its 73.9 MB too big to be delivered on a GitHub server. However, you can load it in via the following .RData file:
load(paste0(wd, "/save_files_CPTAC/MSstats_infile.RData"))

# If you wish to recreate the evidence.txt file, simply write it out to a tab-delimited file again via:
# write.table(infile, file = "evidence.txt", quote = FALSE, sep = "\t", na = "", row.names = FALSE, col.names = TRUE)
# Then import it again the same way as we did via:
# infile <- read.table(paste0(wd,"/datasets/CPTAC/evidence.txt"), sep="\t", header=TRUE)
```

## 2. Summarize the data with ProPCA

```{r eval=TRUE}
# Check
all((fData(peptides.CPTAC2)$protein %in% infile$Proteins))
# TRUE

logSC <- infile %>% select(Proteins, Experiment) %>% group_by(Proteins, Experiment) %>% summarise(SC = n())%>% ungroup() %>% spread(Experiment, SC)

logSC[is.na(logSC)] <- 0

logSC[ , -1] <- (logSC[ , -1]+1) %>% log

# In terms of preprocessing, the ProPCA paper mentions normalization, but doesn't do normalization in the end. The goal of our publication is not to compare normalization approaches.
# Hence, I compared three approaches and picked the best one: (1) ProPCA without normalization, (2) ProPCA with quantile normalization on the peptides intensities (peptides.CPTAC2), but not on logSC, and (3) ProPCA with quantile normalization on the peptides intensities and on the logSC. Option (3) had the best overall performance in terms of ROC. Hence, I normalized both the intensities (by using the quantile normalized peptides.CPTAC2 object) and the counts for ProPCA.
logSC[ ,-1] <- normalizeQuantiles(as.matrix(logSC[,-1]))

# Use ProPCA summarization by using this command:
# prot.CPTAC.ProPCA <- do_ProPCA(peptides.CPTAC2, logSC, group_var = protein, keep_fData_cols = c("gene.name","protein.name")) # lasts about 13 mins. on our system

# OR: load the ProPCA data:
load(paste0(wd, "/save_files_CPTAC/prot_CPTAC_ProPCA.RData"))
```

## 3. Data analysis

```{r eval=TRUE}

# In the original ProPCA publication, they use t-tests, but recognize that t-tests are not always the most appropriate way to analyze the data. In the CPTAC dataset, one should correct for lab-effects. As the ProPCA paper doesn't really recommend a certain method, we will use limma to analyse the data. Limma basically uses a linear regression model and shrinks the variances towards a common variance over all the proteins. This is much more powerful than ordinary t-tests (see e.g. Kammers et al. 2015, Detecting significant changes in protein abundance, EuPA Open Proteomics, https://www.sciencedirect.com/science/article/pii/S2212968515000069).

design <- model.matrix(~ condition + lab, data = pData(prot.CPTAC.ProPCA))
fit <- lmFit(exprs(prot.CPTAC.ProPCA), design)
cont.matrix <- cbind(`condition6B-condition6A`=c(0,1,0,0,0),`condition6C-condition6A`=c(0,0,1,0,0), `condition6C-condition6B` = c(0,-1,1,0,0))
row.names(cont.matrix) <- c("(Intercept)", "condition6B", "condition6C", "labLTQ-OrbitrapO_65", "labLTQ-OrbitrapW_56")
fit2 <- contrasts.fit(fit, cont.matrix)
fit2 <- eBayes(fit2)
topTable(fit2)

BvsA_ProPCA <- topTable(fit2, coef = "condition6B-condition6A", number = Inf)
CvsA_ProPCA <- topTable(fit2, coef = "condition6C-condition6A", number = Inf)
CvsB_ProPCA <- topTable(fit2, coef = "condition6C-condition6B", number = Inf)

BvsA_ProPCA <- data.frame(protein = rownames(BvsA_ProPCA), contrast = "condition6B-condition6A", BvsA_ProPCA)
CvsA_ProPCA <- data.frame(protein = rownames(CvsA_ProPCA), contrast = "condition6C-condition6A", CvsA_ProPCA)
CvsB_ProPCA <- data.frame(protein = rownames(CvsB_ProPCA), contrast = "condition6C-condition6B", CvsB_ProPCA)

res.CPTAC.ProPCA <- rbind(BvsA_ProPCA, CvsA_ProPCA, CvsB_ProPCA)

res.CPTAC.ProPCA.full <- res.CPTAC.Base %>% left_join(res.CPTAC.ProPCA)
res.CPTAC.ProPCA.full <- res.CPTAC.ProPCA.full %>% arrange(P.Value)

# Or load the MSqRob result object via:
# load(paste0(wd, "/save_files_CPTAC/res_CPTAC_ProPCA_full.RData"))

# Optional: remove objects we won't use anymore to free up memory space
rm(BvsA_ProPCA, CvsA_ProPCA, CvsB_ProPCA, res.CPTAC.ProPCA, fit, fit2, design, cont.matrix)
gc()
```



